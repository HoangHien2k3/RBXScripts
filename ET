-- HoangHien_Script: Elementals Tycoon --
local coreui, starterui, singleone, mainframe, sframe, turretframe, toolframe
local openui, lockbutton, switchpage
local creditlb, autoshoot_turret, turretmode, nukeboom, storagetarget, airstrike_mode
local itsHidden, itsLocked, itsPage, itsDefends, switchmode, itOnWorking, current_turretmode, previous_pos, finaln, current_modeairstrike
local ws, plrs, plr, self_name

itsHidden = false
itsLocked = true
itsPage = 1
itsDefends = false
switchmode = 1
current_turretmode = 1
current_modeairstrike = 1

itOnWorking = true

previous_pos = nil

finaln = ""

coreui = game:GetService("CoreGui")
starterui = game:GetService("StarterGui")
ws = game:GetService("Workspace")
plrs = game:GetService("Players")
plr = plrs.LocalPlayer

self_name = plr.Name

singleone = Instance.new("ScreenGui", coreui)
mainframe = Instance.new("Frame", singleone)
sframe = Instance.new("Frame", mainframe)
turretframe = Instance.new("Frame", mainframe)
toolframe = Instance.new("Frame", mainframe)

openui = Instance.new("TextButton", mainframe)
lockbutton = Instance.new("TextButton", mainframe)
switchpage = Instance.new("TextButton", mainframe)

creditlb = Instance.new("TextLabel", sframe)
autoshoot_turret = Instance.new("TextButton", turretframe)
turretmode = Instance.new("TextButton", turretframe)
nukeboom = Instance.new("TextButton", turretframe)
storagetarget = Instance.new("TextBox", singleone)
airstrike_mode = Instance.new("TextButton", turretframe)

singleone.Name = "Elementals_Script"

mainframe.BackgroundTransparency = 0
mainframe.BackgroundColor3 = Color3.new(0, 0, 0)
mainframe.Position = UDim2.new(0.65, 0, -0.1, 0)
mainframe.Size = UDim2.new(0.2, 0, 0.05, 0)
mainframe.Active = true
mainframe.Draggable = true
mainframe.Visible = true

sframe.BackgroundTransparency = 0.5
sframe.BackgroundColor3 = Color3.new(0, 0, 0)
sframe.Position = UDim2.new(0, 0, 1, 0)
sframe.Size = UDim2.new(1, 0, 4.95, 0)
sframe.Active = true
sframe.Draggable = false
sframe.Visible = false

turretframe.BackgroundTransparency = 0.5
turretframe.BackgroundColor3 = Color3.new(0, 0, 0)
turretframe.Position = UDim2.new(0, 0, 1, 0)
turretframe.Size = UDim2.new(1, 0, 4.95, 0)
turretframe.Active = true
turretframe.Draggable = false
turretframe.Visible = false

toolframe.BackgroundTransparency = 0.5
toolframe.BackgroundColor3 = Color3.new(0, 0, 0)
toolframe.Position = UDim2.new(0, 0, 1, 0)
toolframe.Size = UDim2.new(1, 0, 4.95, 0)
toolframe.Active = true
toolframe.Draggable = false
toolframe.Visible = false

openui.BackgroundTransparency = 0
openui.BackgroundColor3 = Color3.new(1, 1, 1)
openui.Position = UDim2.new(0.02, 0, 0.1, 0)
openui.Size = UDim2.new(0.6, 0, 0.8, 0)
openui.TextScaled = true
openui.TextSize = 12
openui.TextColor3 = Color3.new(1, 0, 1)
openui.Font = Enum.Font.Code
openui.Text = "Elementals"
openui.Visible = true

lockbutton.BackgroundTransparency = 0
lockbutton.BackgroundColor3 = Color3.new(1, 1, 1)
lockbutton.Position = UDim2.new(0.65, 0, 0.1, 0)
lockbutton.Size = UDim2.new(0.15, 0, 0.8, 0)
lockbutton.TextScaled = true
lockbutton.TextSize = 12
lockbutton.TextColor3 = Color3.new(0, 1, 0)
lockbutton.Font = Enum.Font.Code
lockbutton.Text = "LockUI"
lockbutton.Visible = true

switchpage.BackgroundTransparency = 0.5
switchpage.BackgroundColor3 = Color3.new(1, 1, 1)
switchpage.Position = UDim2.new(0, 0, 6.25, 0)
switchpage.Size = UDim2.new(1, 0, 0.8, 0)
switchpage.TextScaled = true
switchpage.TextSize = 12
switchpage.TextColor3 = Color3.new(1, 1, 1)
switchpage.Font = Enum.Font.Code
switchpage.Text = "<< Credit Page >>"
switchpage.Visible = false

creditlb.BackgroundTransparency = 0.8
creditlb.BackgroundColor3 = Color3.new(0, 0, 0)
creditlb.Position = UDim2.new(0.02, 0, 0.05, 0)
creditlb.Size = UDim2.new(0.96, 0, 0.2, 0)
creditlb.TextScaled = true
creditlb.TextSize = 12
creditlb.TextColor3 = Color3.new(1, 1, 0)
creditlb.Font = Enum.Font.Code
creditlb.Text = "Script writed by: HoangHien."
creditlb.Visible = true

autoshoot_turret.BackgroundTransparency = 0.8
autoshoot_turret.BackgroundColor3 = Color3.new(0, 0, 0)
autoshoot_turret.Position = UDim2.new(0.02, 0, 0.05, 0)
autoshoot_turret.Size = UDim2.new(0.645, 0, 0.2, 0)
autoshoot_turret.TextScaled = true
autoshoot_turret.TextColor3 = Color3.new(1, 1, 1)
autoshoot_turret.Font = Enum.Font.Code
autoshoot_turret.Text = "Auto Defends: OFF"
autoshoot_turret.Visible = true

turretmode.BackgroundTransparency = 0.8
turretmode.BackgroundColor3 = Color3.new(0, 0, 0)
turretmode.Position = UDim2.new(0.68, 0, 0.05, 0)
turretmode.Size = UDim2.new(0.29, 0, 0.2, 0)
turretmode.TextScaled = true
turretmode.TextColor3 = Color3.new(1, 1, 0)
turretmode.Font = Enum.Font.Code
turretmode.Text = "Nearby"
turretmode.Visible = true

nukeboom.BackgroundTransparency = 0.8
nukeboom.BackgroundColor3 = Color3.new(0, 0, 0)
nukeboom.Position = UDim2.new(0.02, 0, 0.275, 0)
nukeboom.Size = UDim2.new(0.645, 0, 0.2, 0)
nukeboom.TextScaled = true
nukeboom.TextColor3 = Color3.new(1, 1, 1)
nukeboom.Font = Enum.Font.Code
nukeboom.Text = "Air Strike"
nukeboom.Visible = true

storagetarget.BackgroundTransparency = 0.5
storagetarget.BackgroundColor3 = Color3.new(0, 0, 0)
storagetarget.Position = UDim2.new(0.25, 0, 0.69, 0)
storagetarget.Size = UDim2.new(0.15, 0, 0.05, 0)
storagetarget.TextScaled = true
storagetarget.TextSize = 12
storagetarget.TextColor3 = Color3.new(1, 1, 1)
storagetarget.Text = ""
storagetarget.Font = Enum.Font.Code
storagetarget.ClearTextOnFocus = false
storagetarget.PlaceholderText = "= Input Target Name ="
storagetarget.Visible = false

airstrike_mode.BackgroundTransparency = 0.8
airstrike_mode.BackgroundColor3 = Color3.new(0, 0, 0)
airstrike_mode.Position = UDim2.new(0.68, 0, 0.275, 0)
airstrike_mode.Size = UDim2.new(0.29, 0, 0.2, 0)
airstrike_mode.TextScaled = true
airstrike_mode.TextColor3 = Color3.new(1, 1, 0)
airstrike_mode.Font = Enum.Font.Code
airstrike_mode.Text = "Self"
airstrike_mode.Visible = true

-- Connected function --
function correct_username(plrs_name)
    for _, findplrs in ipairs(plrs:GetPlayers()) do
        if string.lower(findplrs.Name):sub(1, #plrs_name) == string.lower(plrs_name) or
        string.lower(findplrs.DisplayName):sub(1, #plrs_name) == string.lower(plrs_name) then
            return findplrs
        end
    end
    return nil
end

function normal_ntf(tl, tx)
    starterui:SetCore("SendNotification", {
        Title = tl,
        Text = tx,
        Duration = 1,
    })
end

function music_mb1c(b, script)
    b.MouseButton1Click:Connect(function()
        script()
    end)
end

function music_fl(b, e, script)
    b.FocusLost:Connect(function(e)
        if e then
            script()
        end
    end)
end

function uic0_2(ui)
    local uic = Instance.new("UICorner", ui)
    uic.CornerRadius = UDim.new(0.2, 0)
end

function hidevisfr(vf)
    if vf.Visible == true then
        vf.Visible = false
    end
end

function visfr(vf)
    vf.Visible = true
end

function hide_Allframe()
    hidevisfr(sframe)
    hidevisfr(turretframe)
    hidevisfr(toolframe)
    hidevisfr(switchpage)
    hidevisfr(storagetarget)
end

function hide_Powerframe()
    hidevisfr(sframe)
    hidevisfr(turretframe)
    hidevisfr(toolframe)
end

-- AbilitySkill function --
local function findneareatENEMY()
    local c_har = plr.Character
    if not c_har then return nil end
    
    local nearestone, closedistance, distance
    nearestone = nil
    closedistance = math.huge
    
    for i, v in ipairs(plrs:GetPlayers()) do
        if v ~= plr and plr.Character then
            distance = (v.Character.HumanoidRootPart.Position - c_har.HumanoidRootPart.Position).magnitude
            if distance < closedistance then
                closedistance = distance
                nearestone = v
            end
        end
    end
    return nearestone
end

local function findfarthestENEMY()
    local c_har = plr.Character
    if not c_har then return nil end
    
    local farthestone, farthestdistance, distance
    farthestone = nil
    farthestdistance = 0
    
    for i, v in ipairs(plrs:GetPlayers()) do
        if v ~= plr and plr.Character then
            distance = (v.Character.HumanoidRootPart.Position - c_har.HumanoidRootPart.Position).magnitude
            if distance > farthestdistance then
                farthestdistance = distance
                farthestone = v
            end
        end
    end
    return farthestone
end

local function findcustomENEMY(username)
    local c_har = plr.Character
    if not c_har then return nil end
    
    local targetPlayer = nil
    
    for i, v in ipairs(plrs:GetPlayers()) do
        if v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
            if v.Name == username then
                targetPlayer = v
            end
        end
    end

    return targetPlayer
end

local function findrandomENEMY()
    local c_har = plr.Character
    if not c_har then return nil end
    
    local players, randomplayers
    players = plrs:GetPlayers()
    table.remove(players, table.find(players, plr))
    
    if #players == 0 then return nil end
    
    randomplayers = players[math.random(1, #players)]
    
    return randomplayers
end

function autoaimshootnearest_turret()
    local Chosen_targetPLRS, humanoidrpPLRS, positionPLRS
    Chosen_targetPLRS = findneareatENEMY()
    humanoidrpPLRS = Chosen_targetPLRS and Chosen_targetPLRS.Character:FindFirstChild("HumanoidRootPart") or plr.Character:FindFirstChild("HumanoidRootPart")
    if humanoidrpPLRS then
        positionPLRS = humanoidrpPLRS.Position
        
        local args = {
            [1] = "Turret",
            [2] = "Energy Ball",
            [3] = {
                ["Mouse"] = positionPLRS,
                ["Gun"] = workspace.Tycoons[self_name].Assets.Turret.XYZGuns.Right,
                ["Camera"] = CFrame.new(0, 0, 0) * CFrame.Angles(0, 0, 0)
                }
            }
            
        game:GetService("ReplicatedStorage").Remotes.DoMagic:FireServer(unpack(args))
        wait(0.01)
    end
end

function autoaimshootfarthest_turret()
    local Chosen_targetPLRS, humanoidrpPLRS, positionPLRS
    Chosen_targetPLRS = findfarthestENEMY()
    humanoidrpPLRS = Chosen_targetPLRS and Chosen_targetPLRS.Character:FindFirstChild("HumanoidRootPart") or plr.Character:FindFirstChild("HumanoidRootPart")
    if humanoidrpPLRS then
        positionPLRS = humanoidrpPLRS.Position
        
        local args = {
            [1] = "Turret",
            [2] = "Energy Ball",
            [3] = {
                ["Mouse"] = positionPLRS,
                ["Gun"] = workspace.Tycoons[self_name].Assets.Turret.XYZGuns.Right,
                ["Camera"] = CFrame.new(0, 0, 0) * CFrame.Angles(0, 0, 0)
                }
            }
            
        game:GetService("ReplicatedStorage").Remotes.DoMagic:FireServer(unpack(args))
        wait(0.01)
    end
end

function autoaimshootcustom_turret(user)
    local Chosen_targetPLRS, humanoidrpPLRS, positionPLRS
    Chosen_targetPLRS = findcustomENEMY(user)

    if Chosen_targetPLRS then
        humanoidrpPLRS = Chosen_targetPLRS.Character:FindFirstChild("HumanoidRootPart")
    end

    if humanoidrpPLRS then
        positionPLRS = humanoidrpPLRS.Position
        
        local args = {
            [1] = "Turret",
            [2] = "Energy Ball",
            [3] = {
                ["Mouse"] = positionPLRS,
                ["Gun"] = workspace.Tycoons[self_name].Assets.Turret.XYZGuns.Right,
                ["Camera"] = CFrame.new(0, 0, 0) * CFrame.Angles(0, 0, 0)
            }
        }
        
        game:GetService("ReplicatedStorage").Remotes.DoMagic:FireServer(unpack(args))
        wait(0.01)
    else
        print("Error: Target not found or invalid!")
    end
end

function autoaimshootrandom_turret()
    local Chosen_targetPLRS, humanoidrpPLRS, positionPLRS
    Chosen_targetPLRS = findrandomENEMY()
    humanoidrpPLRS = Chosen_targetPLRS and Chosen_targetPLRS.Character:FindFirstChild("HumanoidRootPart") or plr.Character:FindFirstChild("HumanoidRootPart")
    if humanoidrpPLRS then
        positionPLRS = humanoidrpPLRS.Position
        
        local args = {
            [1] = "Turret",
            [2] = "Energy Ball",
            [3] = {
                ["Mouse"] = positionPLRS,
                ["Gun"] = workspace.Tycoons[self_name].Assets.Turret.XYZGuns.Right,
                ["Camera"] = CFrame.new(0, 0, 0) * CFrame.Angles(0, 0, 0)
                }
            }
            
        game:GetService("ReplicatedStorage").Remotes.DoMagic:FireServer(unpack(args))
        wait(0.01)
    end
end

-- Nuke Boom function --
function GetPartPos(pn)
    local special = ws:FindFirstChild(pn)
    if special and special:IsA("BasePart") then
        return special.Position
    else
        return nil
    end
end

function JusticeSky(pr)
    if ws:FindFirstChild("LockIn") then
        ws:FindFirstChild("LockIn"):Destroy()
    end
    
    local MainTarget_Part, NukePad_Part, NukePad_PartInt, NearbyOne_toNuke, HumanoidRP_Nearest, PositionNearest
    MainTarget_Part = Instance.new("Part")
    NukePad_Part = ws.Tycoons[self_name].Assets["Air Strike"].Wedge
    
    MainTarget_Part.Anchored = true
    MainTarget_Part.CanCollide = false
    MainTarget_Part.Transparency = 0.9
    MainTarget_Part.Color = Color3.new(1, 0, 0)
    MainTarget_Part.Material = Enum.Material.Neon
    MainTarget_Part.Parent = pr
    MainTarget_Part.Name = "LockIn"
    MainTarget_Part.Size = Vector3.new(5, 0.2, 5)
    MainTarget_Part.Position = Vector3.new(
        plr.Character.HumanoidRootPart.Position.X,
        plr.Character.HumanoidRootPart.Position.Y - 2,
        plr.Character.HumanoidRootPart.Position.Z
    )
    
    if NukePad_Part then
        local checkplrhrp = plr.Character:FindFirstChild("HumanoidRootPart")
        if checkplrhrp then
            if current_modeairstrike == 2 then -- Start: just a test
                NearbyOne_toNuke = findneareatENEMY()
                task.wait(0.2)
            end -- End: i think will remove
            plr.Character.HumanoidRootPart.CFrame = NukePad_Part.CFrame
            task.wait(0.2)
            fireproximityprompt(ws.Tycoons[self_name].Assets["Air Strike"].Interact.ProximityPrompt)
            task.wait(0.35)
            if current_modeairstrike == 1 then
                NukePad_PartInt = GetPartPos("LockIn")
                wait(0.01)
                local args = {
                    [1] = NukePad_PartInt
                }
                
                game:GetService("ReplicatedStorage").Magic.Ability:FindFirstChild("Air Strike").RemoteEvent:FireServer(unpack(args))
            elseif current_modeairstrike == 2 then
                -- NearbyOne_toNuke = findneareatENEMY()
                HumanoidRP_Nearest = NearbyOne_toNuke and NearbyOne_toNuke.Character:FindFirstChild("HumanoidRootPart") or plr.Character:FindFirstChild("HumanoidRootPart")
                if HumanoidRP_Nearest then
                    PositionNearest = HumanoidRP_Nearest.Position
                    wait(0.01)
                    local args = {
                        [1] = PositionNearest
                    }
                    
                    game:GetService("ReplicatedStorage").Magic.Ability:FindFirstChild("Air Strike").RemoteEvent:FireServer(unpack(args))
                else
                    normal_ntf("《Error》", "Player: " .. NearbyOne_toNuke.Name .. " does not exist a HumanoidRootPart !")
                end
            end
            task.wait(0.35)
            plr.Character.HumanoidRootPart.CFrame = ws.LockIn.CFrame
            task.wait(0.15)
            for i, p in pairs(ws:GetChildren()) do
                if p:IsA("Part") and p.Name == "LockIn" then
                    p:Destroy()
                end
            end
        else
            normal_ntf("《Wait for Character》", "You died... i think ?")
        end
    else
        normal_ntf("《Air Strike Requires》", "You need to build Air Strike pad to use this feature button!")
    end
end

-- Connected button --
music_mb1c(openui, function()
    if itsHidden then
        itsHidden = false
        hide_Allframe()
        openui.TextColor3 = Color3.new(1, 0, 1)
    else
        itsHidden = true
        switchpage.Visible = true
        openui.TextColor3 = Color3.new(0, 1, 1)
        if itsPage == 1 then
            sframe.Visible = true
            switchpage.Text = "<< Credit Page >>"
        elseif itsPage == 2 then
            turretframe.Visible = true
            switchpage.Text = "<< Turret Page >>"
        elseif itsPage >= 3 then
            toolframe.Visible = true
            switchpage.Text = "<< Ability Page >>"
        end
        
        if switchmode == 4 then
            visfr(storagetarget)
        end
    end
end)

music_mb1c(lockbutton, function()
    if itsLocked then
        itsLocked = false
        mainframe.Draggable = false
        lockbutton.Text = "UnLockUI"
        lockbutton.TextColor3 = Color3.new(1, 0, 0)
    else
        itsLocked = true
        mainframe.Draggable = true
        lockbutton.Text = "LockUI"
        lockbutton.TextColor3 = Color3.new(0, 1, 0)
    end
end)

music_mb1c(switchpage, function()
    itsPage = itsPage + 1
    hide_Powerframe()
    if itsPage == 2 then
        visfr(turretframe)
        switchpage.Text = "<< Turret Page >>"
    elseif itsPage == 3 then
        visfr(toolframe)
        switchpage.Text = "<< Ability Page >>"
    elseif itsPage >= 4 then
        visfr(sframe)
        switchpage.Text = "<< Credit Page >>"
        itsPage = 1
    end
end)

-- Special button --
music_mb1c(autoshoot_turret, function()
    local towerdefends = ws.Tycoons[self_name].Assets:FindFirstChild("Turret")
    if towerdefends then
        if itsDefends then
            itsDefends = false
            autoshoot_turret.Text = "Auto Defends: OFF"
            autoshoot_turret.TextColor3 = Color3.new(1, 1, 1)
            normal_ntf("《Defends: OFF》", "Turret Stopped Shooting at Target!")
        else
            itsDefends = true
            autoshoot_turret.Text = "Auto Defends: ON"
            autoshoot_turret.TextColor3 = Color3.new(0, 1, 0)
            normal_ntf("《Defends: ON》", "Turret Started Shooting at Target!")
            
            while itsDefends do
                if current_turretmode == 1 then
                    turretmode.Text = "Nearby"
                    pcall(autoaimshootnearest_turret)
                elseif current_turretmode == 2 then
                    turretmode.Text = "Farthest"
                    pcall(autoaimshootfarthest_turret)
                elseif current_turretmode == 3 then
                    turretmode.Text = "Random"
                    pcall(autoaimshootrandom_turret)
                elseif current_turretmode == 4 then
                    turretmode.Text = "User"
                    pcall(function()
                        autoaimshootcustom_turret(finaln.Name)
                    end)
                elseif current_turretmode >= 5 then
                    current_turretmode = 1
                end
                wait(0.01)
            end
        end
    else
        normal_ntf("《Doesnt Exist!》", "You does not have upgrades and build the tower defends yet already... can't use this button, Come back later :> !")
    end
end)

music_mb1c(turretmode, function()
    switchmode = switchmode + 1
    current_turretmode = current_turretmode + 1
    if switchmode == 2 then
        turretmode.Text = "Farthest"
        hidevisfr(storagetarget)
    elseif switchmode == 3 then
        turretmode.Text = "Random"
        hidevisfr(storagetarget)
    elseif switchmode == 4 then
        turretmode.Text = "User"
        visfr(storagetarget)
    elseif switchmode >= 5 then
        turretmode.Text = "Nearby"
        hidevisfr(storagetarget)
        switchmode = 1
    end
end)

music_mb1c(nukeboom, function()
    JusticeSky(ws)
end)

music_fl(storagetarget, enterPressed, function()
    local inputn = storagetarget.Text
    finaln = correct_username(inputn)
    normal_ntf("《User Selected》", "Current ENEMY is: " .. finaln.Name .. " Position !")
end)

music_mb1c(airstrike_mode, function()
    current_modeairstrike = current_modeairstrike + 1
    if current_modeairstrike == 2 then
        airstrike_mode.Text = "Nearby"
    elseif current_modeairstrike >= 3 then
        airstrike_mode.Text = "Self"
        current_modeairstrike = 1
    end
end)

uic0_2(autoshoot_turret)
uic0_2(turretmode)
uic0_2(nukeboom)
uic0_2(storagetarget)
uic0_2(airstrike_mode)